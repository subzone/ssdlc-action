# =============================================================================
# ssdlc-action — Release Workflow
#
# Creates a properly versioned release:
#   1. Patches action.yml image tag from :main → :vX.Y.Z (ephemeral commit)
#   2. Pushes ONLY the git tag (not the patched commit to main)
#   3. The ci.yml Build & Push job triggers on the tag → builds :vX.Y.Z image
#   4. Creates a GitHub Release with auto-generated release notes
#
# Why ephemeral commit?
#   action.yml on `main` always uses :main so branch builds stay in sync.
#   The tagged commit has :vX.Y.Z so `uses: subzone/ssdlc-action@vX.Y.Z`
#   pulls the correct, immutable Docker image — not whatever :main is today.
#
# Usage: Actions → Release → Run workflow → enter version (e.g. 1.1.0)
# =============================================================================

name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release — semver without the v prefix (e.g. 1.1.0)'
        required: true
        type: string
      prerelease:
        description: 'Mark as pre-release?'
        required: false
        default: false
        type: boolean

jobs:
  release:
    name: Tag & Publish
    runs-on: ubuntu-latest

    permissions:
      contents: write   # push tag + create GitHub Release

    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          # Need full history so auto-generated release notes span all commits
          fetch-depth: 0

      - name: Validate version format
        run: |
          if ! echo "${{ inputs.version }}" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+$'; then
            echo "::error::Version must be semver without 'v' prefix (e.g. 1.1.0)"
            exit 1
          fi
          echo "Releasing v${{ inputs.version }}"

      - name: Check tag does not already exist
        run: |
          if git ls-remote --tags origin "refs/tags/v${{ inputs.version }}" | grep -q "v${{ inputs.version }}"; then
            echo "::error::Tag v${{ inputs.version }} already exists"
            exit 1
          fi

      - name: Patch action.yml image tag for release
        run: |
          if [[ ! -f action.yml ]]; then
            echo "::error::action.yml not found in repository root"
            exit 1
          fi
          sed -i \
            "s|docker://ghcr.io/subzone/ssdlc-action:main|docker://ghcr.io/subzone/ssdlc-action:v${{ inputs.version }}|" \
            action.yml
          # Verify the substitution actually happened
          if ! grep -q "ssdlc-action:v${{ inputs.version }}" action.yml; then
            echo "::error::Substitution failed — is action.yml already patched, or does :main not appear?"
            grep "image:" action.yml
            exit 1
          fi
          grep "image:" action.yml   # log confirmed value

      - name: Create tagged release commit
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add action.yml
          # Guard: fail fast if sed made no change (nothing staged)
          if git diff --cached --quiet; then
            echo "::error::action.yml was not modified — sed substitution may have failed"
            exit 1
          fi
          git commit -m "chore: release v${{ inputs.version }}"
          git tag "v${{ inputs.version }}"

      - name: Push tag only (keep main clean)
        run: |
          # Push the tag — this triggers ci.yml Build & Push to publish :vX.Y.Z
          # The release commit is NOT pushed to main; action.yml on main stays :main
          git push origin "v${{ inputs.version }}"

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release create "v${{ inputs.version }}" \
            --title "v${{ inputs.version }}" \
            --generate-notes \
            ${{ inputs.prerelease && '--prerelease' || '' }}
